<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>HackOS v2.4 - System Simulator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&family=Orbitron:wght@400;700;900&display=swap');

  :root {
    --green: #00ff88;
    --green-dim: #00aa55;
    --green-dark: #003322;
    --amber: #ffaa00;
    --red: #ff3344;
    --blue: #00aaff;
    --bg: #050a08;
    --win-bg: #0a1a10;
    --win-border: #00ff88;
    --taskbar-bg: #030d06;
    --text: #00ff88;
    --text-dim: #007744;
    --glow: 0 0 8px #00ff8888;
    --glow-strong: 0 0 16px #00ff88cc;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

  body {
    font-family: 'Share Tech Mono', monospace;
    background: var(--bg);
    color: var(--text);
    width: 100vw; height: 100vh;
    overflow: hidden;
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3E%3Ccircle cx='8' cy='8' r='4' fill='%2300ff88'/%3E%3C/svg%3E") 8 8, crosshair;
  }

  /* ===== SCANLINE OVERLAY ===== */
  #scanlines {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.15) 2px,
      rgba(0,0,0,0.15) 4px
    );
    pointer-events: none; z-index: 9999;
    animation: flicker 8s infinite;
  }

  @keyframes flicker {
    0%,100%{opacity:1} 92%{opacity:1} 93%{opacity:0.97} 94%{opacity:1} 96%{opacity:0.95} 97%{opacity:1}
  }

  /* ===== VIGNETTE ===== */
  #vignette {
    position: fixed; top:0;left:0;width:100%;height:100%;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.7) 100%);
    pointer-events: none; z-index: 9998;
  }

  /* ===== DESKTOP ===== */
  #desktop {
    position: absolute; top:0; left:0;
    width: 100%; height: calc(100% - 40px);
    background:
      radial-gradient(ellipse 80% 60% at 20% 80%, #001a08 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 20%, #001408 0%, transparent 50%),
      repeating-conic-gradient(#050a08 0% 25%, #060c09 0% 50%) 0 0 / 40px 40px,
      #050a08;
    overflow: hidden;
  }

  /* Grid pattern */
  #desktop::before {
    content: '';
    position: absolute; inset: 0;
    background-image:
      linear-gradient(var(--green-dark) 1px, transparent 1px),
      linear-gradient(90deg, var(--green-dark) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
  }

  /* ===== DESKTOP ICONS ===== */
  .desktop-icon {
    position: absolute;
    width: 70px; text-align: center;
    cursor: pointer; padding: 6px;
    border: 1px solid transparent;
    border-radius: 4px;
    transition: all 0.15s;
  }

  .desktop-icon:hover {
    background: rgba(0,255,136,0.1);
    border-color: var(--green-dim);
    box-shadow: var(--glow);
  }

  .desktop-icon .icon-img {
    font-size: 32px; display: block; margin-bottom: 4px;
    filter: drop-shadow(0 0 6px var(--green));
  }

  .desktop-icon .icon-label {
    font-size: 10px; color: var(--text);
    text-shadow: 0 0 6px var(--green);
    word-break: break-word;
  }

  /* ===== TASKBAR ===== */
  #taskbar {
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 40px; background: var(--taskbar-bg);
    border-top: 1px solid var(--green-dim);
    display: flex; align-items: center;
    gap: 4px; padding: 0 8px;
    box-shadow: 0 -2px 20px rgba(0,255,136,0.1);
    z-index: 100;
  }

  #start-btn {
    background: var(--green-dark);
    border: 1px solid var(--green);
    color: var(--green);
    font-family: 'Orbitron', sans-serif;
    font-size: 11px; font-weight: 700;
    padding: 4px 12px; cursor: pointer;
    letter-spacing: 2px;
    box-shadow: var(--glow);
    transition: all 0.15s;
  }
  #start-btn:hover { background: var(--green); color: var(--bg); }

  .taskbar-sep { width: 1px; height: 24px; background: var(--green-dim); opacity: 0.4; margin: 0 4px; }

  .taskbar-win {
    background: rgba(0,255,136,0.08);
    border: 1px solid var(--green-dim);
    color: var(--text-dim);
    font-size: 11px; padding: 3px 10px;
    cursor: pointer; max-width: 140px;
    overflow: hidden; text-overflow: ellipsis;
    white-space: nowrap; transition: all 0.15s;
  }
  .taskbar-win:hover, .taskbar-win.active {
    background: rgba(0,255,136,0.18);
    color: var(--text); border-color: var(--green);
    box-shadow: var(--glow);
  }

  #taskbar-right {
    margin-left: auto; display: flex; align-items: center; gap: 16px;
  }

  #clock {
    font-family: 'VT323', monospace;
    font-size: 20px; color: var(--green);
    text-shadow: var(--glow);
    min-width: 60px; text-align: right;
  }

  #net-status {
    font-size: 10px; color: var(--green-dim);
  }

  /* ===== WINDOWS ===== */
  .window {
    position: absolute;
    min-width: 280px; min-height: 180px;
    background: var(--win-bg);
    border: 1px solid var(--win-border);
    box-shadow: 0 0 20px rgba(0,255,136,0.2), inset 0 0 30px rgba(0,255,136,0.03);
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  .window.focused {
    border-color: var(--green);
    box-shadow: 0 0 30px rgba(0,255,136,0.4), inset 0 0 30px rgba(0,255,136,0.05);
    z-index: 50 !important;
  }

  .titlebar {
    height: 30px; background: rgba(0,255,136,0.12);
    border-bottom: 1px solid var(--green-dim);
    display: flex; align-items: center;
    padding: 0 8px; gap: 8px;
    cursor: move; flex-shrink: 0;
  }

  .titlebar-dots { display: flex; gap: 5px; }
  .dot {
    width: 10px; height: 10px; border-radius: 50%;
    cursor: pointer; transition: all 0.15s;
  }
  .dot-close { background: var(--red); box-shadow: 0 0 4px var(--red); }
  .dot-min { background: var(--amber); box-shadow: 0 0 4px var(--amber); }
  .dot-max { background: var(--green); box-shadow: 0 0 4px var(--green); }
  .dot:hover { transform: scale(1.2); }

  .titlebar-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px; letter-spacing: 2px;
    color: var(--text); text-shadow: var(--glow);
    flex: 1; text-align: center;
  }

  .win-content {
    flex: 1; overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* Resize handle */
  .resize-handle {
    position: absolute; bottom: 0; right: 0;
    width: 14px; height: 14px;
    cursor: se-resize;
    background: linear-gradient(135deg, transparent 50%, var(--green-dim) 50%);
    opacity: 0.6;
  }

  /* ===== TERMINAL ===== */
  .terminal-output {
    flex: 1; overflow-y: auto; padding: 10px;
    font-size: 13px; line-height: 1.6;
    scrollbar-width: thin;
    scrollbar-color: var(--green-dim) transparent;
  }

  .terminal-output::-webkit-scrollbar { width: 4px; }
  .terminal-output::-webkit-scrollbar-track { background: transparent; }
  .terminal-output::-webkit-scrollbar-thumb { background: var(--green-dim); }

  .term-line { margin: 1px 0; word-break: break-all; }
  .term-line.cmd { color: var(--amber); }
  .term-line.err { color: var(--red); }
  .term-line.success { color: var(--green); }
  .term-line.info { color: var(--blue); }
  .term-line.dim { color: var(--text-dim); }
  .term-line.header {
    color: var(--green); font-family: 'VT323', monospace;
    font-size: 18px; text-shadow: var(--glow-strong);
  }

  .terminal-input-row {
    display: flex; align-items: center;
    padding: 6px 10px;
    border-top: 1px solid var(--green-dark);
    flex-shrink: 0;
  }

  .terminal-prompt {
    color: var(--amber); margin-right: 6px;
    font-size: 13px; white-space: nowrap;
  }

  .terminal-input {
    flex: 1; background: transparent;
    border: none; outline: none;
    color: var(--text); font-family: 'Share Tech Mono', monospace;
    font-size: 13px; caret-color: var(--green);
    cursor: text;
  }

  /* ===== EMAIL CLIENT ===== */
  .email-layout { display: flex; flex: 1; overflow: hidden; }

  .email-list {
    width: 200px; border-right: 1px solid var(--green-dark);
    overflow-y: auto; flex-shrink: 0;
  }

  .email-item {
    padding: 8px 10px; cursor: pointer;
    border-bottom: 1px solid rgba(0,255,136,0.1);
    transition: background 0.1s;
  }

  .email-item:hover, .email-item.selected {
    background: rgba(0,255,136,0.1);
  }

  .email-item.unread .email-from { color: var(--green); font-weight: bold; }
  .email-item.unread::before {
    content: '‚óè'; color: var(--amber); margin-right: 6px; font-size: 8px;
  }
  .email-from { font-size: 11px; color: var(--text-dim); }
  .email-subj { font-size: 12px; color: var(--text); margin-top: 2px; }
  .email-date { font-size: 9px; color: var(--text-dim); margin-top: 2px; }

  .email-view {
    flex: 1; padding: 12px; overflow-y: auto; font-size: 12px;
  }

  .email-header-view { border-bottom: 1px solid var(--green-dark); padding-bottom: 10px; margin-bottom: 10px; }
  .email-header-view h3 { color: var(--green); font-size: 14px; margin-bottom: 6px; }
  .email-header-view .meta { color: var(--text-dim); font-size: 11px; line-height: 1.8; }
  .email-body { line-height: 1.8; color: var(--text-dim); white-space: pre-wrap; }

  /* ===== FILE MANAGER ===== */
  .fileman-toolbar {
    padding: 6px 10px;
    border-bottom: 1px solid var(--green-dark);
    font-size: 11px; color: var(--text-dim);
    display: flex; align-items: center; gap: 8px;
  }

  .path-bar {
    flex: 1; background: rgba(0,255,136,0.05);
    border: 1px solid var(--green-dark);
    padding: 2px 8px; color: var(--text);
    font-family: 'Share Tech Mono', monospace; font-size: 11px;
  }

  .file-grid {
    display: flex; flex-wrap: wrap;
    padding: 10px; gap: 8px;
    overflow-y: auto; align-content: flex-start;
    flex: 1;
  }

  .file-item {
    width: 80px; text-align: center;
    padding: 8px 4px; cursor: pointer;
    border: 1px solid transparent; border-radius: 4px;
    transition: all 0.15s;
  }

  .file-item:hover {
    background: rgba(0,255,136,0.1);
    border-color: var(--green-dim);
    box-shadow: var(--glow);
  }

  .file-icon { font-size: 28px; display: block; margin-bottom: 4px; }
  .file-name { font-size: 10px; color: var(--text); word-break: break-all; }
  .file-item.locked .file-icon { filter: grayscale(0.5); opacity: 0.7; }
  .file-item.locked .file-name { color: var(--red); }

  /* ===== TEXT EDITOR ===== */
  .texteditor-content {
    flex: 1; padding: 12px;
    overflow-y: auto; font-size: 12px;
    line-height: 1.8; white-space: pre-wrap;
    color: var(--text-dim);
    outline: none;
  }

  .editor-toolbar {
    padding: 4px 8px; border-bottom: 1px solid var(--green-dark);
    font-size: 10px; color: var(--text-dim); flex-shrink: 0;
  }

  /* ===== PASSWORD DIALOG ===== */
  .pwd-dialog {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: var(--win-bg);
    border: 1px solid var(--amber);
    box-shadow: 0 0 30px rgba(255,170,0,0.4);
    padding: 24px 28px; z-index: 10000;
    min-width: 300px; text-align: center;
  }

  .pwd-dialog h3 {
    font-family: 'Orbitron', sans-serif;
    color: var(--amber); margin-bottom: 16px;
    font-size: 12px; letter-spacing: 3px;
  }

  .pwd-dialog input {
    width: 100%; background: rgba(0,0,0,0.5);
    border: 1px solid var(--amber); color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px; padding: 8px 12px;
    letter-spacing: 3px; text-align: center;
    outline: none; margin-bottom: 12px;
  }

  .pwd-dialog input:focus { box-shadow: 0 0 10px rgba(255,170,0,0.4); }

  .pwd-dialog .btn-row { display: flex; gap: 8px; justify-content: center; }

  .btn {
    background: transparent; border: 1px solid var(--green);
    color: var(--text); font-family: 'Share Tech Mono', monospace;
    font-size: 12px; padding: 6px 16px; cursor: pointer;
    transition: all 0.15s; letter-spacing: 1px;
  }
  .btn:hover { background: var(--green); color: var(--bg); }
  .btn.danger { border-color: var(--red); }
  .btn.danger:hover { background: var(--red); }

  /* ===== NOTIFICATION ===== */
  #notifications {
    position: fixed; top: 10px; right: 10px;
    z-index: 9990; display: flex; flex-direction: column; gap: 8px;
  }

  .notif {
    background: var(--win-bg);
    border: 1px solid var(--amber);
    padding: 10px 14px; min-width: 220px;
    font-size: 12px; color: var(--text);
    box-shadow: 0 0 16px rgba(255,170,0,0.3);
    animation: slideIn 0.3s ease;
  }

  .notif.success { border-color: var(--green); box-shadow: 0 0 16px rgba(0,255,136,0.3); }
  .notif.error { border-color: var(--red); box-shadow: 0 0 16px rgba(255,51,68,0.3); }

  .notif-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px; letter-spacing: 2px;
    margin-bottom: 4px; color: var(--amber);
  }
  .notif.success .notif-title { color: var(--green); }
  .notif.error .notif-title { color: var(--red); }

  @keyframes slideIn {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* ===== BOOT SCREEN ===== */
  #boot-screen {
    position: fixed; inset: 0;
    background: #000;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 99999;
    font-family: 'VT323', monospace;
  }

  #boot-logo {
    font-size: 60px; color: var(--green);
    text-shadow: 0 0 30px var(--green), 0 0 60px rgba(0,255,136,0.3);
    margin-bottom: 20px;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%,100%{opacity:1;text-shadow:0 0 30px var(--green),0 0 60px rgba(0,255,136,0.3)}
    50%{opacity:0.8;text-shadow:0 0 50px var(--green),0 0 80px rgba(0,255,136,0.5)}
  }

  #boot-text {
    font-size: 16px; color: var(--green-dim);
    width: 500px; text-align: left;
    line-height: 1.7;
  }

  #boot-progress-container {
    width: 400px; height: 4px;
    background: var(--green-dark);
    margin-top: 20px;
  }

  #boot-progress {
    height: 100%; background: var(--green);
    box-shadow: var(--glow); width: 0%;
    transition: width 0.1s linear;
  }

  /* ===== BROWSER ===== */
  .browser-bar {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 10px; border-bottom: 1px solid var(--green-dark);
    flex-shrink: 0;
  }

  .browser-url {
    flex: 1; background: rgba(0,255,136,0.05);
    border: 1px solid var(--green-dark); color: var(--text);
    font-family: 'Share Tech Mono', monospace; font-size: 12px;
    padding: 4px 10px; outline: none;
  }

  .browser-url:focus { border-color: var(--green); box-shadow: var(--glow); }

  .browser-content {
    flex: 1; overflow-y: auto; padding: 16px;
    font-size: 13px; line-height: 1.8;
  }

  .browser-page h1 { color: var(--green); font-family: 'Orbitron', sans-serif; font-size: 16px; margin-bottom: 12px; }
  .browser-page h2 { color: var(--amber); font-size: 13px; margin: 10px 0 6px; }
  .browser-page p { color: var(--text-dim); margin-bottom: 8px; }
  .browser-page .link { color: var(--blue); cursor: pointer; text-decoration: underline; }
  .browser-page .link:hover { color: var(--green); }
  .browser-page hr { border: none; border-top: 1px solid var(--green-dark); margin: 12px 0; }
  .browser-page .highlight { background: rgba(0,255,136,0.1); padding: 2px 6px; color: var(--green); }

  /* ===== PROGRESS TRACKER ===== */
  #progress-panel {
    position: absolute; top: 10px; right: 10px;
    background: rgba(5,10,8,0.9);
    border: 1px solid var(--green-dim);
    padding: 10px 14px; font-size: 11px;
    min-width: 180px;
    box-shadow: var(--glow);
  }

  #progress-panel h4 {
    font-family: 'Orbitron', sans-serif;
    font-size: 9px; letter-spacing: 2px;
    color: var(--green-dim); margin-bottom: 8px;
  }

  .obj-item { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
  .obj-check { color: var(--green); }
  .obj-pending { color: var(--text-dim); }
  .obj-text { color: var(--text-dim); }
  .obj-text.done { color: var(--text-dim); text-decoration: line-through; }
  .obj-text.active { color: var(--text); }
</style>
</head>
<body>

<!-- Scanlines & vignette -->
<div id="scanlines"></div>
<div id="vignette"></div>

<!-- Boot screen -->
<div id="boot-screen">
  <div id="boot-logo">‚¨° HACK OS</div>
  <div id="boot-text" id="boot-msgs"></div>
  <div id="boot-progress-container"><div id="boot-progress"></div></div>
</div>

<!-- Desktop -->
<div id="desktop"></div>

<!-- Taskbar -->
<div id="taskbar">
  <button id="start-btn" onclick="toggleStartMenu()">‚ñ∂ START</button>
  <div class="taskbar-sep"></div>
  <div id="taskbar-wins"></div>
  <div id="taskbar-right">
    <span id="net-status">üåê NET: ACTIVE</span>
    <span id="clock">00:00</span>
  </div>
</div>

<!-- Notifications -->
<div id="notifications"></div>

<!-- Start Menu (hidden by default) -->
<div id="start-menu" style="display:none;position:absolute;bottom:40px;left:0;background:#0a1a10;border:1px solid #00ff88;border-bottom:none;min-width:200px;z-index:200;">
  <div style="padding:6px 12px;font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;color:#00aa55;border-bottom:1px solid #003322;">HACK OS v2.4</div>
</div>

<script>
// ===== GAME STATE =====
const state = {
  windows: [],
  nextZIndex: 10,
  nextWinId: 0,
  dragging: null,
  resizing: null,
  dragOffset: {x:0, y:0},
  objectives: {
    readEmail: false,
    accessTerminal: false,
    findPassword: false,
    hackServer: false,
    readSecret: false
  },
  unlockedFiles: new Set(),
  foundPassword: null,
  gameComplete: false,
};

// ===== FILESYSTEM =====
const FS = {
  'C:/': ['system/', 'users/', 'logs/'],
  'C:/system/': ['boot.cfg', 'kernel.bin', 'net.dll'],
  'C:/users/': ['operative/'],
  'C:/users/operative/': ['desktop/', 'documents/', '.hidden/'],
  'C:/users/operative/desktop/': ['readme.txt', 'mission.txt'],
  'C:/users/operative/documents/': ['notes.txt', 'access_codes.enc', 'nova_corp_plan.pdf'],
  'C:/users/operative/.hidden/': ['vault_key.txt', 'evidence.png', 'contact.msg'],
};

const FILES = {
  'readme.txt': `HACK OS v2.4 - Operative Briefing
===================================
Welcome, Agent.

Your mission: Infiltrate NOVA CORP's internal network
and retrieve classified documents about Project PHANTOM.

Start by checking your EMAIL for mission details.
Use the TERMINAL to navigate the system.

Type 'help' in terminal for available commands.

Good luck. Delete this file when done.`,

  'mission.txt': `MISSION FILE - CLASSIFIED
=========================
Target: Nova Corp Server (192.168.1.42)
Objective: Access /server/phantom/ directory
Clearance needed: LEVEL 3

Hint: Check the email from 'darknet_anon@void.net'
The password is hidden in plain sight.`,

  'notes.txt': `Personal notes - DO NOT READ
==============================
- Meeting with informant: Tuesday
- The vault password format: [animal][year]
- Remember: my cat's name is "CIPHER"
- Born 2019... wait, adopted 2019

TODO:
- Delete this file (IMPORTANT!)
- Check server logs`,

  'access_codes.enc': `[ENCRYPTED - ACCESS DENIED]
Encryption: AES-256
To decrypt, provide authentication token.

ERROR: Unauthorized access attempt logged.`,

  'nova_corp_plan.pdf': `[LOCKED] - Requires password
This file is encrypted with a 9-character password.

HINT: Think about what the notes say...
animal + year = ?`,

  'vault_key.txt': `FOUND IT.

The key to everything:
vault_password = "CIPHER2019"

Use this to access the Nova Corp server.
Don't tell anyone where you found this.

- H`,

  'evidence.png': `[IMAGE FILE: evidence.png]
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
[Screenshot of Nova Corp internal dashboard]
[Timestamp: 2024-03-15 23:47:02]
[Shows: Project PHANTOM - Budget: $2.4B]
[Classification: ULTRAVIOLET]
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
This image is solid evidence of illegal activities.`,

  'contact.msg': `Encrypted message from: SHADOW
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"Operative - 

The vault key is on this machine somewhere.
Once you find it, connect to the server:
  ssh nova_corp@192.168.1.42

Use command: hack 192.168.1.42

The files you need are in /server/phantom/

Do NOT get caught. This message will
self-destruct in 60 seconds.

- SHADOW"`,
};

const EMAILS = [
  {
    id: 1, from: 'darknet_anon@void.net',
    subject: '*** URGENT: Mission parameters ***',
    date: '2024-03-15 22:13',
    unread: true,
    body: `Operative,

We have intercepted communications from Nova Corp.
They are preparing to launch Project PHANTOM in 72 hours.

YOUR MISSION:
1. Access their internal server: 192.168.1.42
2. Retrieve files from /server/phantom/
3. Send evidence to our drop point

The server requires a password. 
Our intel suggests it's stored locally on your machine.
Check your hidden files (.hidden folder).

The password hint is somewhere in your documents.
Think carefully. You have until dawn.

Burn this message after reading.

- DARKNET ANONYMOUS`,
    triggerObjective: 'readEmail'
  },
  {
    id: 2, from: 'system@hackos.local',
    subject: 'SYSTEM: Security scan complete',
    date: '2024-03-15 20:00',
    unread: false,
    body: `AUTOMATED SECURITY REPORT
==========================
Scan time: 2024-03-15 20:00:01
Status: ANOMALIES DETECTED

- Unknown connection attempt: 192.168.1.42
- Hidden directory access: 3 files
- Encryption status: PARTIAL

Recommend immediate action.

HackOS Security Daemon v1.2`
  },
  {
    id: 3, from: 'boss@novacorp.com',
    subject: 'RE: Project PHANTOM - DO NOT FORWARD',
    date: '2024-03-14 09:31',
    unread: true,
    body: `[INTERCEPTED - Nova Corp Internal Email]

From: Director Walsh <walsh@novacorp.com>
To: Team PHANTOM

Gentlemen,

The operation moves forward as planned.
All documentation has been encrypted and moved to
the secure server. Access code: PHANTOM-ALPHA-7

Do NOT discuss this over unencrypted channels.

The world will never know.

- Walsh, Director`
  }
];

const BROWSER_PAGES = {
  'hacknet://home': `<div class="browser-page">
    <h1>üåê HACKNET BROWSER v3.1</h1>
    <hr>
    <h2>Quick Links</h2>
    <p><span class="link" onclick="browserNav('hacknet://search')">¬ª DarkSearch Engine</span></p>
    <p><span class="link" onclick="browserNav('hacknet://192.168.1.42')">¬ª Nova Corp Server [192.168.1.42]</span></p>
    <p><span class="link" onclick="browserNav('hacknet://tools')">¬ª Hacker Toolbox</span></p>
    <hr>
    <p style="color:var(--red)">‚ö† WARNING: You are being monitored. Obfuscate your connection.</p>
  </div>`,

  'hacknet://search': `<div class="browser-page">
    <h1>üîç DARKSEARCH</h1>
    <hr>
    <p>Search the dark web for information...</p>
    <p><span class="link" onclick="browserNav('hacknet://novacorp')">¬ª nova corp phantom project</span></p>
    <p><span class="link" onclick="browserNav('hacknet://passwords')">¬ª default server passwords</span></p>
  </div>`,

  'hacknet://novacorp': `<div class="browser-page">
    <h1>Nova Corp - Public Info</h1>
    <hr>
    <p>Nova Corp is a multinational technology firm founded in 2008.</p>
    <p>Revenue: $4.2 billion (2023)</p>
    <h2>Projects</h2>
    <p>Most projects are <span class="highlight">classified</span>. Project PHANTOM is rumored to involve surveillance technology.</p>
    <hr>
    <p style="color:var(--amber)">‚ö† This page may be monitored by Nova Corp</p>
  </div>`,

  'hacknet://tools': `<div class="browser-page">
    <h1>‚öô HACKER TOOLBOX</h1>
    <hr>
    <h2>Available Tools</h2>
    <p>‚Ä¢ <span class="highlight">ssh</span> - Secure shell connection</p>
    <p>‚Ä¢ <span class="highlight">scan</span> - Network port scanner (use in terminal)</p>
    <p>‚Ä¢ <span class="highlight">hack [ip]</span> - Penetration tool (use in terminal)</p>
    <p>‚Ä¢ <span class="highlight">decrypt [file]</span> - File decryption (use in terminal)</p>
    <hr>
    <p>All tools available via terminal. Type 'help' for full list.</p>
  </div>`,

  'hacknet://192.168.1.42': `<div class="browser-page">
    <h1>üîí NOVA CORP SECURE SERVER</h1>
    <hr>
    <p style="color:var(--red)">ACCESS DENIED - AUTHENTICATION REQUIRED</p>
    <p>This server requires SSH authentication.</p>
    <p>Use terminal command: <span class="highlight">hack 192.168.1.42</span></p>
    <hr>
    <p style="color:var(--text-dim)">Server: Nova Corp Internal // Security Level: MAXIMUM</p>
  </div>`,

  'hacknet://passwords': `<div class="browser-page">
    <h1>Password Security Guide</h1>
    <hr>
    <p>Common password patterns used in corporate environments:</p>
    <p>‚Ä¢ Pet names + numbers</p>
    <p>‚Ä¢ Names + birth years</p>
    <p>‚Ä¢ Dictionary words + special chars</p>
    <h2>Tip</h2>
    <p>People often write passwords in <span class="highlight">personal notes</span> or documents. Check user directories!</p>
  </div>`,
};

// ===== SERVER STATE =====
const SERVER = {
  connected: false,
  files: ['phantom_plan.txt', 'budget.enc', 'targets.lst', 'README_CLASSIFIED.txt'],
  fileContents: {
    'phantom_plan.txt': `PROJECT PHANTOM - CLASSIFIED
==============================
Phase 1: Deploy surveillance nodes (COMPLETE)
Phase 2: Data collection begins 2024-04-01
Phase 3: Sell data to highest bidder

This is what we've been looking for.
EVIDENCE SECURED.`,
    'README_CLASSIFIED.txt': `If you're reading this, you've gone too far.
Our lawyers will be in touch.
- Nova Corp Legal Dept`
  }
};

// ===== BOOT SEQUENCE =====
const bootMessages = [
  'BIOS v2.4.1 ... OK',
  'Memory check: 32768MB ... OK',
  'Loading kernel ... OK',
  'Mounting filesystems ... OK',
  'Starting network daemon ... OK',
  'Loading HackOS environment ...',
  'Decrypting operative files ...',
  'Establishing secure connection ...',
  '> System ready.',
];

async function boot() {
  const bootText = document.getElementById('boot-text');
  const progress = document.getElementById('boot-progress');
  
  for (let i = 0; i < bootMessages.length; i++) {
    await sleep(300 + Math.random() * 200);
    const line = document.createElement('div');
    line.textContent = bootMessages[i];
    bootText.appendChild(line);
    progress.style.width = ((i+1)/bootMessages.length*100) + '%';
  }
  
  await sleep(600);
  
  document.getElementById('boot-screen').style.transition = 'opacity 1s';
  document.getElementById('boot-screen').style.opacity = '0';
  await sleep(1000);
  document.getElementById('boot-screen').style.display = 'none';
  
  initDesktop();
  showNotif('SYSTEM', 'Welcome, Operative. Check your email.', 'default');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ===== DESKTOP SETUP =====
function initDesktop() {
  const desktop = document.getElementById('desktop');
  
  const icons = [
    { label: 'Terminal', icon: '‚¨õ', x: 20, y: 20, action: () => openTerminal() },
    { label: 'Email', icon: 'üìß', x: 20, y: 120, action: () => openEmail(), badge: '2' },
    { label: 'Files', icon: 'üìÅ', x: 20, y: 220, action: () => openFileManager() },
    { label: 'Browser', icon: 'üåê', x: 20, y: 320, action: () => openBrowser() },
  ];
  
  icons.forEach(ic => {
    const el = document.createElement('div');
    el.className = 'desktop-icon';
    el.style.left = ic.x + 'px';
    el.style.top = ic.y + 'px';
    el.innerHTML = `<span class="icon-img">${ic.icon}</span><span class="icon-label">${ic.label}</span>`;
    el.ondblclick = ic.action;
    desktop.appendChild(el);
  });
  
  // Progress panel
  const pp = document.createElement('div');
  pp.id = 'progress-panel';
  pp.innerHTML = `<h4>‚¨° OBJECTIVES</h4><div id="obj-list"></div>`;
  desktop.appendChild(pp);
  
  updateObjectives();
  updateClock();
  setInterval(updateClock, 1000);
}

function updateObjectives() {
  const defs = [
    { key: 'readEmail', text: 'Read mission email' },
    { key: 'accessTerminal', text: 'Access terminal' },
    { key: 'findPassword', text: 'Find vault password' },
    { key: 'hackServer', text: 'Hack Nova Corp server' },
    { key: 'readSecret', text: 'Read PHANTOM files' },
  ];
  
  const list = document.getElementById('obj-list');
  if (!list) return;
  list.innerHTML = '';
  
  defs.forEach(d => {
    const done = state.objectives[d.key];
    const div = document.createElement('div');
    div.className = 'obj-item';
    div.innerHTML = `<span class="${done ? 'obj-check' : 'obj-pending'}">${done ? '‚úì' : '‚óã'}</span>
      <span class="obj-text ${done ? 'done' : 'active'}">${d.text}</span>`;
    list.appendChild(div);
  });
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
}

// ===== WINDOW SYSTEM =====
function createWindow(title, width, height, x, y) {
  const id = ++state.nextWinId;
  const z = ++state.nextZIndex;
  
  const win = document.createElement('div');
  win.className = 'window focused';
  win.id = 'win-' + id;
  win.style.cssText = `left:${x}px;top:${y}px;width:${width}px;height:${height}px;z-index:${z};`;
  
  win.innerHTML = `
    <div class="titlebar" id="tb-${id}">
      <div class="titlebar-dots">
        <div class="dot dot-close" onclick="closeWindow(${id})" title="Close"></div>
        <div class="dot dot-min" onclick="minimizeWindow(${id})" title="Minimize"></div>
        <div class="dot dot-max" title="Maximize"></div>
      </div>
      <div class="titlebar-title">${title}</div>
      <div style="width:52px"></div>
    </div>
    <div class="win-content" id="content-${id}"></div>
    <div class="resize-handle" id="rh-${id}"></div>
  `;
  
  document.getElementById('desktop').appendChild(win);
  
  state.windows.push({ id, title, minimized: false });
  focusWindow(id);
  updateTaskbar();
  setupWindowEvents(win, id);
  
  return id;
}

function setupWindowEvents(win, id) {
  const tb = document.getElementById('tb-' + id);
  const rh = document.getElementById('rh-' + id);
  
  // Drag
  tb.addEventListener('mousedown', e => {
    if (e.target.classList.contains('dot')) return;
    focusWindow(id);
    state.dragging = id;
    state.dragOffset = { x: e.clientX - win.offsetLeft, y: e.clientY - win.offsetTop };
    e.preventDefault();
  });
  
  // Resize
  rh.addEventListener('mousedown', e => {
    state.resizing = { id, startX: e.clientX, startY: e.clientY, startW: win.offsetWidth, startH: win.offsetHeight };
    e.preventDefault();
  });
  
  // Focus on click
  win.addEventListener('mousedown', () => focusWindow(id));
}

document.addEventListener('mousemove', e => {
  if (state.dragging !== null) {
    const win = document.getElementById('win-' + state.dragging);
    if (win) {
      const nx = Math.max(0, Math.min(e.clientX - state.dragOffset.x, window.innerWidth - win.offsetWidth));
      const ny = Math.max(0, Math.min(e.clientY - state.dragOffset.y, window.innerHeight - 80));
      win.style.left = nx + 'px';
      win.style.top = ny + 'px';
    }
  }
  
  if (state.resizing) {
    const { id, startX, startY, startW, startH } = state.resizing;
    const win = document.getElementById('win-' + id);
    if (win) {
      const newW = Math.max(280, startW + e.clientX - startX);
      const newH = Math.max(180, startH + e.clientY - startY);
      win.style.width = newW + 'px';
      win.style.height = newH + 'px';
    }
  }
});

document.addEventListener('mouseup', () => {
  state.dragging = null;
  state.resizing = null;
});

function focusWindow(id) {
  document.querySelectorAll('.window').forEach(w => w.classList.remove('focused'));
  const win = document.getElementById('win-' + id);
  if (win) {
    win.classList.add('focused');
    win.style.zIndex = ++state.nextZIndex;
  }
  updateTaskbar();
}

function closeWindow(id) {
  const win = document.getElementById('win-' + id);
  if (win) win.remove();
  state.windows = state.windows.filter(w => w.id !== id);
  updateTaskbar();
}

function minimizeWindow(id) {
  const win = document.getElementById('win-' + id);
  const w = state.windows.find(w => w.id === id);
  if (win && w) {
    if (w.minimized) {
      win.style.display = 'flex';
      w.minimized = false;
    } else {
      win.style.display = 'none';
      w.minimized = true;
    }
    updateTaskbar();
  }
}

function updateTaskbar() {
  const bar = document.getElementById('taskbar-wins');
  bar.innerHTML = '';
  state.windows.forEach(w => {
    const btn = document.createElement('div');
    btn.className = 'taskbar-win' + (!w.minimized ? ' active' : '');
    btn.textContent = w.title;
    btn.onclick = () => minimizeWindow(w.id);
    bar.appendChild(btn);
  });
}

// ===== TERMINAL =====
function openTerminal() {
  state.objectives.accessTerminal = true;
  updateObjectives();
  
  const id = createWindow('TERMINAL', 560, 380, 100, 80);
  const content = document.getElementById('content-' + id);
  
  const output = document.createElement('div');
  output.className = 'terminal-output';
  output.id = 'term-out-' + id;
  
  const inputRow = document.createElement('div');
  inputRow.className = 'terminal-input-row';
  inputRow.innerHTML = `
    <span class="terminal-prompt" id="term-prompt-${id}">operative@hackos:C:/ $</span>
    <input class="terminal-input" id="term-in-${id}" autocomplete="off" spellcheck="false" placeholder="type 'help' for commands...">
  `;
  
  content.appendChild(output);
  content.appendChild(inputRow);
  
  const inp = document.getElementById('term-in-' + id);
  const termState = { cwd: 'C:/', history: [], histIdx: -1 };
  
  termPrint(id, 'header', '‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó');
  termPrint(id, 'header', '‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù');
  termPrint(id, 'header', '‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ');
  termPrint(id, 'header', '‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë ');
  termPrint(id, 'dim',    '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  termPrint(id, 'success', 'HackOS Terminal v2.4 ‚Äî Type "help" for commands');
  termPrint(id, 'dim', '');
  
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const cmd = inp.value.trim();
      if (!cmd) return;
      termState.history.unshift(cmd);
      termState.histIdx = -1;
      termPrint(id, 'cmd', `${termState.cwd} > ${cmd}`);
      inp.value = '';
      handleTerminalCmd(id, cmd, termState);
      playTypeSound();
    } else if (e.key === 'ArrowUp') {
      termState.histIdx = Math.min(termState.histIdx + 1, termState.history.length - 1);
      inp.value = termState.history[termState.histIdx] || '';
    } else if (e.key === 'ArrowDown') {
      termState.histIdx = Math.max(termState.histIdx - 1, -1);
      inp.value = termState.histIdx >= 0 ? termState.history[termState.histIdx] : '';
    }
  });
  
  inp.focus();
}

function termPrint(id, cls, text) {
  const out = document.getElementById('term-out-' + id);
  if (!out) return;
  const line = document.createElement('div');
  line.className = 'term-line ' + cls;
  line.textContent = text;
  out.appendChild(line);
  out.scrollTop = out.scrollHeight;
}

function handleTerminalCmd(winId, fullCmd, ts) {
  const parts = fullCmd.toLowerCase().trim().split(/\s+/);
  const cmd = parts[0];
  const args = parts.slice(1);
  
  switch(cmd) {
    case 'help':
      termPrint(winId, 'info', '‚îå‚îÄ AVAILABLE COMMANDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
      termPrint(winId, 'info', '‚îÇ ls              - list directory contents     ‚îÇ');
      termPrint(winId, 'info', '‚îÇ cd [dir]        - change directory            ‚îÇ');
      termPrint(winId, 'info', '‚îÇ cat [file]      - read file contents          ‚îÇ');
      termPrint(winId, 'info', '‚îÇ pwd             - print working directory     ‚îÇ');
      termPrint(winId, 'info', '‚îÇ scan [ip]       - scan network host           ‚îÇ');
      termPrint(winId, 'info', '‚îÇ hack [ip]       - initiate connection         ‚îÇ');
      termPrint(winId, 'info', '‚îÇ server ls       - list server files           ‚îÇ');
      termPrint(winId, 'info', '‚îÇ server cat [f]  - read server file            ‚îÇ');
      termPrint(winId, 'info', '‚îÇ clear           - clear terminal              ‚îÇ');
      termPrint(winId, 'info', '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
      break;
      
    case 'pwd':
      termPrint(winId, 'success', ts.cwd);
      break;
      
    case 'ls': {
      const dir = ts.cwd.endsWith('/') ? ts.cwd : ts.cwd + '/';
      const contents = FS[dir];
      if (!contents) { termPrint(winId, 'err', 'ls: cannot access: No such directory'); break; }
      contents.forEach(f => {
        const isDir = f.endsWith('/');
        termPrint(winId, isDir ? 'info' : 'success', (isDir ? 'üìÅ ' : 'üìÑ ') + f);
      });
      break;
    }
      
    case 'cd': {
      if (!args[0]) { ts.cwd = 'C:/'; break; }
      const target = args[0];
      if (target === '..') {
        const parts2 = ts.cwd.split('/').filter(Boolean);
        parts2.pop();
        ts.cwd = parts2.length ? parts2.join('/') + '/' : 'C:/';
        break;
      }
      let newPath;
      if (target.includes(':')) { newPath = target.endsWith('/') ? target : target + '/'; }
      else { newPath = ts.cwd + target + (target.endsWith('/') ? '' : '/'); }
      if (FS[newPath]) { ts.cwd = newPath; termPrint(winId, 'dim', `Changed to: ${ts.cwd}`); }
      else { termPrint(winId, 'err', `cd: ${target}: No such directory`); }
      break;
    }
      
    case 'cat': {
      if (!args[0]) { termPrint(winId, 'err', 'Usage: cat [filename]'); break; }
      const fn = args[0];
      const content = FILES[fn];
      if (!content) { termPrint(winId, 'err', `cat: ${fn}: No such file`); break; }
      
      // Check if we found the vault key
      if (fn === 'vault_key.txt') {
        state.objectives.findPassword = true;
        state.foundPassword = 'CIPHER2019';
        updateObjectives();
        showNotif('DISCOVERY', 'Found vault password: CIPHER2019', 'success');
      }
      
      content.split('\n').forEach(l => termPrint(winId, 'dim', l));
      break;
    }
      
    case 'scan':
      if (!args[0]) { termPrint(winId, 'err', 'Usage: scan [ip]'); break; }
      termPrint(winId, 'info', `Scanning ${args[0]}...`);
      setTimeout(() => {
        termPrint(winId, 'success', `Host: ${args[0]} - ONLINE`);
        termPrint(winId, 'dim', 'Open ports: 22 (SSH), 80 (HTTP), 443 (HTTPS)');
        termPrint(winId, 'dim', 'Security: HIGH ‚Äî Requires authentication');
        if (args[0] === '192.168.1.42') {
          termPrint(winId, 'info', 'Hint: Use "hack 192.168.1.42" to connect');
        }
      }, 1500);
      break;
      
    case 'hack':
      if (!args[0]) { termPrint(winId, 'err', 'Usage: hack [ip]'); break; }
      if (args[0] !== '192.168.1.42') { termPrint(winId, 'err', 'Host unreachable or not a target.'); break; }
      
      if (!state.foundPassword) {
        termPrint(winId, 'err', 'Connection failed: Authentication required.');
        termPrint(winId, 'info', 'Hint: Find the password first. Check your documents.');
        break;
      }
      
      termPrint(winId, 'info', 'Initiating connection to 192.168.1.42...');
      termPrint(winId, 'dim', 'Routing through proxy nodes...');
      
      setTimeout(() => {
        termPrint(winId, 'dim', '[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%');
        termPrint(winId, 'success', `Connected! Password accepted: ${state.foundPassword}`);
        termPrint(winId, 'success', 'Welcome to Nova Corp Secure Server.');
        SERVER.connected = true;
        state.objectives.hackServer = true;
        updateObjectives();
        showNotif('HACKED', 'Nova Corp server breached!', 'success');
        termPrint(winId, 'info', 'Use "server ls" and "server cat [file]" to navigate.');
      }, 2500);
      break;
      
    case 'server':
      if (!SERVER.connected) { termPrint(winId, 'err', 'Not connected to server. Use "hack 192.168.1.42" first.'); break; }
      if (args[0] === 'ls') {
        termPrint(winId, 'info', '--- Nova Corp Server: /server/phantom/ ---');
        SERVER.files.forEach(f => termPrint(winId, 'success', 'üìÑ ' + f));
      } else if (args[0] === 'cat') {
        const sf = args[1];
        if (!sf || !SERVER.fileContents[sf]) { termPrint(winId, 'err', `File not found: ${sf || '(no file specified)'}`); break; }
        SERVER.fileContents[sf].split('\n').forEach(l => termPrint(winId, 'dim', l));
        if (sf === 'phantom_plan.txt') {
          state.objectives.readSecret = true;
          updateObjectives();
          checkGameComplete();
        }
      } else {
        termPrint(winId, 'err', 'server: use "server ls" or "server cat [file]"');
      }
      break;
      
    case 'clear':
      document.getElementById('term-out-' + winId).innerHTML = '';
      break;
      
    default:
      termPrint(winId, 'err', `Command not found: ${cmd}. Type 'help' for available commands.`);
  }
}

// ===== EMAIL =====
function openEmail() {
  const id = createWindow('EMAIL CLIENT', 580, 400, 160, 60);
  const content = document.getElementById('content-' + id);
  
  const layout = document.createElement('div');
  layout.className = 'email-layout';
  
  // List
  const list = document.createElement('div');
  list.className = 'email-list';
  
  const view = document.createElement('div');
  view.className = 'email-view';
  view.innerHTML = '<p style="color:var(--text-dim);margin-top:40px;text-align:center;">Select an email to read</p>';
  
  EMAILS.forEach(email => {
    const item = document.createElement('div');
    item.className = 'email-item' + (email.unread ? ' unread' : '');
    item.innerHTML = `
      <div class="email-from">${email.from}</div>
      <div class="email-subj">${email.subject}</div>
      <div class="email-date">${email.date}</div>
    `;
    item.onclick = () => {
      document.querySelectorAll('.email-item').forEach(i => i.classList.remove('selected'));
      item.classList.add('selected');
      item.classList.remove('unread');
      email.unread = false;
      
      view.innerHTML = `
        <div class="email-header-view">
          <h3>${email.subject}</h3>
          <div class="meta">
            <div>From: ${email.from}</div>
            <div>Date: ${email.date}</div>
          </div>
        </div>
        <div class="email-body">${email.body}</div>
      `;
      
      if (email.triggerObjective) {
        state.objectives[email.triggerObjective] = true;
        updateObjectives();
        showNotif('MISSION UPDATE', 'New objective unlocked!', 'default');
      }
    };
    list.appendChild(item);
  });
  
  layout.appendChild(list);
  layout.appendChild(view);
  content.appendChild(layout);
}

// ===== FILE MANAGER =====
function openFileManager(path) {
  path = path || 'C:/';
  const id = createWindow('FILE EXPLORER', 520, 380, 200, 100);
  const content = document.getElementById('content-' + id);
  
  let currentPath = path;
  
  const toolbar = document.createElement('div');
  toolbar.className = 'fileman-toolbar';
  toolbar.innerHTML = `<span>üìÅ</span><input class="path-bar" id="pathbar-${id}" value="${currentPath}" readonly>`;
  
  const grid = document.createElement('div');
  grid.className = 'file-grid';
  
  content.appendChild(toolbar);
  content.appendChild(grid);
  
  function renderPath(p) {
    currentPath = p;
    document.getElementById('pathbar-' + id).value = p;
    grid.innerHTML = '';
    
    // Back button
    if (p !== 'C:/') {
      const back = document.createElement('div');
      back.className = 'file-item';
      back.innerHTML = `<span class="file-icon">‚Ü©</span><span class="file-name">[..]</span>`;
      back.ondblclick = () => {
        const parts = p.split('/').filter(Boolean);
        parts.pop();
        renderPath(parts.length ? parts.join('/') + '/' : 'C:/');
      };
      grid.appendChild(back);
    }
    
    const entries = FS[p] || [];
    entries.forEach(entry => {
      const isDir = entry.endsWith('/');
      const item = document.createElement('div');
      
      // Check if locked
      const isLocked = (entry === '.hidden/' && false); // hidden dir is accessible
      const isHidden = entry === '.hidden/';
      
      item.className = 'file-item' + (isLocked ? ' locked' : '');
      item.innerHTML = `
        <span class="file-icon">${isDir ? (isHidden ? 'üîí' : 'üìÅ') : getFileIcon(entry)}</span>
        <span class="file-name">${entry}</span>
      `;
      
      item.ondblclick = () => {
        if (isDir) {
          renderPath(p + entry);
        } else {
          openFile(entry, p);
        }
      };
      
      grid.appendChild(item);
    });
  }
  
  renderPath(currentPath);
}

function getFileIcon(filename) {
  if (filename.endsWith('.txt')) return 'üìÑ';
  if (filename.endsWith('.pdf')) return 'üìï';
  if (filename.endsWith('.png') || filename.endsWith('.jpg')) return 'üñº';
  if (filename.endsWith('.enc')) return 'üîê';
  if (filename.endsWith('.msg')) return '‚úâ';
  if (filename.endsWith('.cfg') || filename.endsWith('.dll') || filename.endsWith('.bin')) return '‚öô';
  return 'üìÑ';
}

function openFile(filename, path) {
  const content = FILES[filename];
  if (!content) return;
  
  // Check if it's a locked file
  if (filename === 'nova_corp_plan.pdf') {
    if (!state.foundPassword) {
      showPasswordDialog('nova_corp_plan.pdf', null);
      return;
    }
  }
  
  if (filename === 'vault_key.txt') {
    state.objectives.findPassword = true;
    state.foundPassword = 'CIPHER2019';
    updateObjectives();
    showNotif('KEY FOUND', 'Password: CIPHER2019', 'success');
  }
  
  // Open text editor
  const id = createWindow('EDITOR: ' + filename, 460, 320, 250 + Math.random()*100, 120 + Math.random()*80);
  const winContent = document.getElementById('content-' + id);
  
  winContent.innerHTML = `
    <div class="editor-toolbar">READ-ONLY  ‚Ä¢  ${filename}  ‚Ä¢  ${content.length} bytes</div>
    <div class="texteditor-content">${escHtml(content)}</div>
  `;
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showPasswordDialog(filename, callback) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;';
  
  const dialog = document.createElement('div');
  dialog.className = 'pwd-dialog';
  dialog.innerHTML = `
    <h3>üîê ENCRYPTED FILE</h3>
    <p style="color:var(--text-dim);font-size:12px;margin-bottom:14px;">Enter password to decrypt: ${filename}</p>
    <input type="password" id="pwd-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20">
    <div class="btn-row">
      <button class="btn" onclick="checkPassword('${filename}')">DECRYPT</button>
      <button class="btn danger" onclick="closePwdDialog()">CANCEL</button>
    </div>
    <p id="pwd-error" style="color:var(--red);font-size:11px;margin-top:10px;"></p>
  `;
  
  overlay.id = 'pwd-overlay';
  overlay.appendChild(dialog);
  document.body.appendChild(overlay);
  
  document.getElementById('pwd-input').focus();
  document.getElementById('pwd-input').onkeydown = e => {
    if (e.key === 'Enter') checkPassword(filename);
  };
}

window.checkPassword = function(filename) {
  const inp = document.getElementById('pwd-input');
  if (!inp) return;
  const pwd = inp.value.toUpperCase();
  
  if (pwd === 'CIPHER2019') {
    closePwdDialog();
    showNotif('DECRYPTED', 'File unlocked successfully!', 'success');
    const id = createWindow('EDITOR: ' + filename, 460, 320, 280, 140);
    const c = document.getElementById('content-' + id);
    c.innerHTML = `
      <div class="editor-toolbar">DECRYPTED  ‚Ä¢  ${filename}</div>
      <div class="texteditor-content">${escHtml(`NOVA CORP PLAN - PROJECT PHANTOM\n================================\nThis is the smoking gun.\nFull details of the illegal data selling operation.\nTarget date: 2024-04-01\n\nCongratulations, operative. You found it.`)}</div>
    `;
  } else {
    document.getElementById('pwd-error').textContent = '‚úó Invalid password. Try again.';
    inp.value = '';
    playErrorSound();
  }
};

window.closePwdDialog = function() {
  const overlay = document.getElementById('pwd-overlay');
  if (overlay) overlay.remove();
};

// ===== BROWSER =====
function openBrowser() {
  const id = createWindow('HACKNET BROWSER', 540, 400, 180, 70);
  const content = document.getElementById('content-' + id);
  
  let currentUrl = 'hacknet://home';
  
  const bar = document.createElement('div');
  bar.className = 'browser-bar';
  bar.innerHTML = `
    <span style="color:var(--text-dim);font-size:12px;">‚óÄ ‚ñ∂</span>
    <input class="browser-url" id="burl-${id}" value="${currentUrl}">
    <button class="btn" style="padding:4px 10px;font-size:11px;" onclick="goUrl(${id})">GO</button>
  `;
  
  const browserContent = document.createElement('div');
  browserContent.className = 'browser-content';
  browserContent.id = 'bcontent-' + id;
  
  content.appendChild(bar);
  content.appendChild(browserContent);
  
  window[`browserNav`] = function(url) {
    document.getElementById('burl-' + id).value = url;
    loadPage(id, url);
  };
  
  window[`goUrl`] = function(winId) {
    const url = document.getElementById('burl-' + winId).value;
    loadPage(winId, url);
  };
  
  document.getElementById('burl-' + id).onkeydown = e => {
    if (e.key === 'Enter') loadPage(id, e.target.value);
  };
  
  loadPage(id, currentUrl);
}

function loadPage(winId, url) {
  const content = document.getElementById('bcontent-' + winId);
  if (!content) return;
  const page = BROWSER_PAGES[url];
  if (page) {
    content.innerHTML = page;
  } else {
    content.innerHTML = `<div class="browser-page">
      <h1>404 - PAGE NOT FOUND</h1>
      <hr>
      <p>Could not load: <span class="highlight">${url}</span></p>
      <p><span class="link" onclick="browserNav('hacknet://home')">‚Üê Go Home</span></p>
    </div>`;
  }
}

// ===== GAME COMPLETE =====
function checkGameComplete() {
  const all = Object.values(state.objectives).every(v => v);
  if (all && !state.gameComplete) {
    state.gameComplete = true;
    setTimeout(() => {
      showWinScreen();
    }, 1000);
  }
}

function showWinScreen() {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed;inset:0;background:rgba(0,0,0,0.92);
    z-index:99990;display:flex;align-items:center;justify-content:center;
    font-family:'VT323',monospace;text-align:center;
  `;
  overlay.innerHTML = `
    <div>
      <div style="font-size:80px;color:var(--green);text-shadow:0 0 40px var(--green);margin-bottom:20px;">
        ‚úì MISSION COMPLETE
      </div>
      <div style="font-size:24px;color:var(--text-dim);margin-bottom:30px;line-height:2;">
        You have successfully infiltrated Nova Corp<br>
        and retrieved the classified Project PHANTOM files.<br>
        The evidence has been secured.
      </div>
      <div style="color:var(--amber);font-size:20px;margin-bottom:30px;">
        All objectives completed. The truth is out.
      </div>
      <button class="btn" style="font-size:18px;padding:12px 40px;" onclick="location.reload()">
        ‚Ü∫ PLAY AGAIN
      </button>
    </div>
  `;
  document.body.appendChild(overlay);
}

// ===== NOTIFICATIONS =====
function showNotif(title, msg, type) {
  const container = document.getElementById('notifications');
  const notif = document.createElement('div');
  notif.className = 'notif ' + (type || '');
  notif.innerHTML = `<div class="notif-title">${title}</div><div>${msg}</div>`;
  container.appendChild(notif);
  setTimeout(() => notif.remove(), 4000);
}

// ===== SOUNDS =====
let audioCtx = null;

function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playTypeSound() {
  try {
    const ctx = getAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'square';
    osc.frequency.setValueAtTime(800 + Math.random() * 400, ctx.currentTime);
    gain.gain.setValueAtTime(0.02, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
    osc.start();
    osc.stop(ctx.currentTime + 0.05);
  } catch(e) {}
}

function playErrorSound() {
  try {
    const ctx = getAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(200, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.08, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
    osc.start();
    osc.stop(ctx.currentTime + 0.3);
  } catch(e) {}
}

// ===== START MENU =====
function toggleStartMenu() {
  const menu = document.getElementById('start-menu');
  if (menu.style.display === 'none') {
    menu.style.display = 'block';
    menu.innerHTML = `
      <div style="padding:6px 12px;font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;color:#00aa55;border-bottom:1px solid #003322;">HACK OS v2.4</div>
      <div class="email-item" onclick="openTerminal();toggleStartMenu()" style="padding:10px 16px">‚¨õ Terminal</div>
      <div class="email-item" onclick="openEmail();toggleStartMenu()" style="padding:10px 16px">üìß Email</div>
      <div class="email-item" onclick="openFileManager();toggleStartMenu()" style="padding:10px 16px">üìÅ Files</div>
      <div class="email-item" onclick="openBrowser();toggleStartMenu()" style="padding:10px 16px">üåê Browser</div>
      <div style="border-top:1px solid #003322;padding:8px 16px;font-size:10px;color:#007744">
        Agent: Operative-7<br>Clearance: LEVEL-3
      </div>
    `;
  } else {
    menu.style.display = 'none';
  }
}

document.addEventListener('mousedown', e => {
  const menu = document.getElementById('start-menu');
  const btn = document.getElementById('start-btn');
  if (menu.style.display !== 'none' && !menu.contains(e.target) && e.target !== btn) {
    menu.style.display = 'none';
  }
});

// ===== BOOT =====
boot();
</script>
</body>
</html>
